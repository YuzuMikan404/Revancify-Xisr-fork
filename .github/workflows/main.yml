name: Daily Sync Upstream Release (keep custom import.sh)

on:
  schedule:
    # 日本時間 夜 21:00頃 → UTC 12:00
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # タグpush・リリース作成に必須

    steps:
      - name: Checkout my fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest upstream release info
        id: upstream
        env:
          GH_TOKEN: ${{ github.token }}   # ← ここが必須！これで gh api が動く
        run: |
          set -euo pipefail
          
          LATEST=$(gh api -H "Accept: application/vnd.github+json" \
            repos/Xisrr1/Revancify-Xisr/releases/latest --jq '.tag_name // empty')
          
          if [ -z "$LATEST" ]; then
            echo "No release found or API error" >&2
            exit 1
          fi
          
          echo "latest_tag=$LATEST" >> "$GITHUB_OUTPUT"
          
          URL="https://github.com/Xisrr1/Revancify-Xisr/releases/tag/$LATEST"
          echo "upstream_url=$URL" >> "$GITHUB_OUTPUT"

      - name: Check if tag already exists in my repo (remote)
        id: tag_check
        run: |
          if git ls-remote --exit-code --tags origin "${{ steps.upstream.outputs.latest_tag }}" >/dev/null 2>&1; then
            echo "already_exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag ${{ steps.upstream.outputs.latest_tag }} already present → skipping sync"
          else
            echo "already_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - if: steps.tag_check.outputs.already_exists == 'true'
        name: Skip entire sync (already up to date)
        run: |
          echo "Latest upstream release is already synced. Exiting."
          exit 0

      - name: Download upstream release archive
        run: |
          TAG="${{ steps.upstream.outputs.latest_tag }}"
          ZIP_URL="https://github.com/Xisrr1/Revancify-Xisr/archive/refs/tags/${TAG}.zip"
          curl -L -f -o upstream.zip "$ZIP_URL" || { echo "Failed to download zip from $ZIP_URL"; exit 1; }
          unzip -q upstream.zip
          # ディレクトリ名対応を柔軟に（v付き/なし両対応）
          mv Revancify-Xisr-* upstream-source 2>/dev/null || { echo "Failed to find extracted dir"; exit 1; }

      - name: Sync files except modules/app/import.sh
        id: rsync
        continue-on-error: true
        run: |
          rsync -av --exclude='modules/app/import.sh' --exclude='.git*' --exclude='upstream-source' \
            upstream-source/ ./

      - name: Check if there are actual changes
        id: git_status
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add --all
          if git diff --cached --quiet && git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No meaningful changes (only import.sh or nothing differs)"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            git diff --cached --stat
          fi

      - name: Commit changes (if any)
        if: steps.git_status.outputs.has_changes == 'true'
        run: |
          git commit -m "chore(sync): sync upstream ${{ steps.upstream.outputs.latest_tag }} (excluding modules/app/import.sh)" || echo "Nothing to commit"

      - name: Force create/tag and push (always if tag missing or changes)
        if: steps.git_status.outputs.has_changes == 'true' || steps.tag_check.outputs.already_exists == 'false'
        run: |
          TAG="${{ steps.upstream.outputs.latest_tag }}"
          git tag -f "$TAG"
          git push origin --force "tag $TAG" || { echo "Failed to push tag"; exit 1; }

      - name: Create or replace GitHub Release
        if: steps.git_status.outputs.has_changes == 'true' || steps.tag_check.outputs.already_exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}   # ← ここも必須
        run: |
          TAG="${{ steps.upstream.outputs.latest_tag }}"
          UPSTREAM_URL="${{ steps.upstream.outputs.upstream_url }}"
          
          BODY=$(cat <<EOF
          This is an auto-patched fork of upstream release **${TAG}**.

          **Custom patch kept:**
          - modules/app/import.sh (reverted bad changes from v1.4.0)

          Original upstream release: ${UPSTREAM_URL}

          Synced daily while preserving the fixed import.sh.
          EOF
          )

          # 既存があれば削除（エラー無視）
          gh release delete "$TAG" --yes 2>/dev/null || true

          # リリース作成
          gh release create "$TAG" \
            --title "${TAG}" \
            --notes "$BODY" \
            --target "$(git rev-parse HEAD)" || { echo "Failed to create release"; exit 1; }

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -rf upstream-source upstream.zip || true
